<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
	<link rel="stylesheet" type="text/css" href="css/styles.css" />
	<link rel="stylesheet" type="text/css" href="css/header.css" />
</head>

<body>
	<header class="header-fixed">
		<div class="header-limiter">
			<h1><a href="#">Company<span>logo</span></a></h1>
			<nav>
				<a href="tasks.html">Home</a>
				<a href="profile.html">Profile</a>
				<a href="users.html">Users</a>
				<a href="LogoutServlet">Logout</a> |
			</nav>
		</div>
	</header>

	<div class="container">

		 <div class="col-lg-8">
                <h1 id="title">Task Title</h1>
                <!-- Author -->
                <p class="lead">
                    <a href="#" id="author">author</a> <span id="select"></span>
                </p>
                <p class="lead" id="status">
                    Status: 
                </p>

                <p><span class="glyphicon glyphicon-time"></span>Due date: <span id="time"></span> </p>

                <!-- Post Content -->
                <p class="lead" id="desc">Put Description of the task here!</p>
                

               
                <!-- Posted Comments -->
				<div id="comments">
                <!-- Comment -->
                
				</div>
        
                      
                <!-- Comments Form -->
                <div class="well">
                    <h4>Leave a Comment:</h4>
                    <form role="form">
                        <div class="form-group">
                            <textarea class="form-control" rows="3" id="content"></textarea>
                            <button class="btn btn-default" onClick="leaveComment(); return false;" >Leave comment</button>
                        </div>
                    </form>
                </div>

            </div>
			</div>	
	<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
	<script>
		function leaveComment() {
			 $.ajax({
	              url: '/TaskManager/comment',
	              type: 'POST',
	              data: JSON.stringify({"content" : $('#content').val(), "taskId":getParameterByName("id"),"action":"1"}),
	              cache: false,
	              dataType: 'json',
	              processData: false,
	              contentType: "application/json",
	              statusCode: {
		        	    200: function(data) {
		        	    	console.log(data);
		        	    	showComment(data);
		        	      },
		        	   	403: function() {
		        	   		alert("error with script");
		        	   	}
	         	}
	              
	         });
			
			
			
		}
		
		$(function() {
			var id=getParameterByName("id");
			$.ajax({
	              url: '/TaskManager/comment',
	              type: 'POST',
	              data: JSON.stringify({"action" : "2", "taskId" : id}),
	              contentType: "application/json",
	              dataType: 'json',
	              statusCode: {
		        	    200: function(data) {
		        	    	for(var i = 0; i < data.length; i++) {
		        	    		showComment(data[i]);
		        	    	}
		        	      },
		        	   	403: function() {
		        	   		alert("error with script");
		        	   	}
	         	}
			});
			$.ajax({
	              url: '/TaskManager/task',
	              type: 'POST',
	              data: JSON.stringify({"action" : "3", "taskId" : id}),
	              contentType: "application/json",
	              dataType: 'json',
	              statusCode: {
		        	    200: function(data) {
		        	    	taskData=data.taskData;
		        	    	$('#title').html(taskData.title);
		        	    	$('#status').html(" Status: " + taskData.status);
		        	    	$('#desc').html(taskData.description);
		        	    	$('#time').html(taskData.dueDate);
		        	    	if(!taskData.assignee) {
		        	    		$('#author').html("Not assigned ");
		        	    		var select=$('<select>').attr("onclick","ChangeAssignee(this)");
		        	    		select.append($("<option></option>")
		        	    		         .text("Assign to:"));
		        	    		$.each(data.users, function(key, value) {   
		        	    			select
		        	    		         .append($("<option></option>")
		        	    		         .attr("value",value.userName)
		        	    		         .text(value.userName));
		        	    		});
		        	    		$('#select').append(select);
		        	    	}
		        	    	else {
		        	    		$('#author').html("Assigned to "+taskData.assignee);
		        	    	}
		        	    	
		        	    	
		        	      },
		        	   	403: function() {
		        	   		alert("error with script");
		        	   	}
	         	}
			});
		});
		
		function showComment(obj) {
			var commentsDiv=$('#comments');
    	    var mainDiv=$('<div>').addClass('media');
    		var title=$('<h4>').addClass('media-heading').html(obj.userName);
    		var time=$('<small>').html(obj.date);
    		var content=$('<p>').html(obj.content);
    		
    		title.append(time);
    		
    		mainDiv.append(title);
    		mainDiv.append(content);
    		commentsDiv.prepend(mainDiv);
			
		}
		
		function ChangeAssignee(select) {
			var id=getParameterByName("id");
			$.ajax({
	              url: '/TaskManager/task',
	              type: 'POST',
	              data: JSON.stringify({"action" : "4", "taskId" : id,"assignee" : $(select).val()}),
	              contentType: "application/json",
	              dataType: 'json',
	              statusCode: {
		        	    200: function(data) {
		        	    	//alert("Success assigned to " +  $(select).val());
		        	      },
		        	   	403: function() {
		        	   		alert("error with script");
		        	   	}
	         	}
			});
		}
		
	</script>
</body>
</html>